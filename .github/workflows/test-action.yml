name: End-to-End Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  test-migrate:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flyway
        uses: red-gate/setup-flyway@v1

      - name: Run migrate action with sample project
        id: migrate
        uses: ./flyway/migrations/deploy
        with:
          url: jdbc:sqlite:database/test.db
          working-directory: flyway/sample-project

      - name: Print migration outputs
        shell: bash
        run: |
          echo "Exit code: ${{ steps.migrate.outputs.exit-code }}"
          echo "Migrations applied: ${{ steps.migrate.outputs.migrations-applied }}"
          echo "Schema version: ${{ steps.migrate.outputs.schema-version }}"

      - name: Assert exit code is 0
        shell: bash
        run: |
          set -euo pipefail
          test "${{ steps.migrate.outputs.exit-code }}" = "0"

      - name: Assert migrations applied is 3
        shell: bash
        run: |
          set -euo pipefail
          test "${{ steps.migrate.outputs.migrations-applied }}" = "3"

      - name: Assert schema version is 3
        shell: bash
        run: |
          set -euo pipefail
          test "${{ steps.migrate.outputs.schema-version }}" = "3"
