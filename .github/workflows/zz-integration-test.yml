name: Integration Tests

on:
  workflow_call:

jobs:
  list:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Run root action
        id: list
        uses: ./
      - name: Test outputs
        shell: bash
        run: |
          set -euo pipefail
          echo "Actions: ${{ steps.list.outputs.actions }}"
          echo '${{ steps.list.outputs.actions }}' | jq -e '. | length > 0'
          echo '${{ steps.list.outputs.actions }}' | jq -e '. | index("migrations/checks") != null'
          echo '${{ steps.list.outputs.actions }}' | jq -e '. | index("migrations/deploy") != null'

  migrations-checks:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Retrieve secrets from Vault
        uses: hashicorp/vault-action@v3.4.0
        with:
          method: jwt
          path: ${{ vars.VAULT_AUTH_PATH }}
          url: ${{ vars.VAULT_URL }}
          role: "flyway-actions"
          secrets: |
            build-secrets/data/repos/red-gate/flyway-actions/flyway FLYWAY_PERMIT_ENTERPRISE | FLYWAY_PERMIT_ENTERPRISE;
      - name: Setup Flyway
        uses: red-gate/setup-flyway@v3
        env:
          REDGATE_LICENSING_PERMIT: ${{ env.FLYWAY_PERMIT_ENTERPRISE }}
        with:
          edition: enterprise
          i-agree-to-the-eula: true
      - name: Run checks
        id: checks
        uses: ./migrations/checks
        env:
          REDGATE_LICENSING_PERMIT: ${{ env.FLYWAY_PERMIT_ENTERPRISE }}
        with:
          target-url: jdbc:sqlite:database/no-drift.db
          build-url: jdbc:sqlite:database/build.db
          build-ok-to-erase: 'true'
          fail-on-code-review: 'false'
          working-directory: sample-project
          report-name: flyway-checks-report
          report-retention-days: '1'
      - name: Verify report artifact uploaded
        uses: actions/download-artifact@v4
        with:
          name: flyway-checks-report
      - name: Verify report exists
        shell: bash
        run: test -s report.html

  migrations-checks-fail-on-drift:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Retrieve secrets from Vault
        uses: hashicorp/vault-action@v3.4.0
        with:
          method: jwt
          path: ${{ vars.VAULT_AUTH_PATH }}
          url: ${{ vars.VAULT_URL }}
          role: "flyway-actions"
          secrets: |
            build-secrets/data/repos/red-gate/flyway-actions/flyway FLYWAY_PERMIT_ENTERPRISE | FLYWAY_PERMIT_ENTERPRISE;
      - name: Setup Flyway
        uses: red-gate/setup-flyway@v3
        env:
          REDGATE_LICENSING_PERMIT: ${{ env.FLYWAY_PERMIT_ENTERPRISE }}
        with:
          edition: enterprise
          i-agree-to-the-eula: true
      - name: Run checks with drift
        id: checks
        uses: ./migrations/checks
        continue-on-error: true
        env:
          REDGATE_LICENSING_PERMIT: ${{ env.FLYWAY_PERMIT_ENTERPRISE }}
        with:
          target-url: jdbc:sqlite:database/drift.db
          fail-on-code-review: 'false'
          working-directory: sample-project
          report-name: flyway-drift-report
      - name: Verify report artifact uploaded
        uses: actions/download-artifact@v4
        with:
          name: flyway-drift-report
      - name: Verify report exists
        shell: bash
        run: test -s report.html
      - name: Verify checks failed due to drift
        shell: bash
        run: test "${{ steps.checks.outcome }}" != "success"

  migrations-checks-fail-on-code-review:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Retrieve secrets from Vault
        uses: hashicorp/vault-action@v3.4.0
        with:
          method: jwt
          path: ${{ vars.VAULT_AUTH_PATH }}
          url: ${{ vars.VAULT_URL }}
          role: "flyway-actions"
          secrets: |
            build-secrets/data/repos/red-gate/flyway-actions/flyway FLYWAY_PERMIT_ENTERPRISE | FLYWAY_PERMIT_ENTERPRISE;
      - name: Setup Flyway
        uses: red-gate/setup-flyway@v3
        env:
          REDGATE_LICENSING_PERMIT: ${{ env.FLYWAY_PERMIT_ENTERPRISE }}
        with:
          edition: enterprise
          i-agree-to-the-eula: true
      - name: Run checks with code violations
        id: checks
        uses: ./migrations/checks
        continue-on-error: true
        env:
          REDGATE_LICENSING_PERMIT: ${{ env.FLYWAY_PERMIT_ENTERPRISE }}
        with:
          target-url: jdbc:sqlite:database/no-drift.db
          working-directory: sample-project
          skip-html-report-upload: 'true'
      - name: Verify checks failed due to code review
        shell: bash
        run: test "${{ steps.checks.outcome }}" != "success"

  migrations-deploy-no-drift:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    runs-on: ${{ matrix.os }}
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Retrieve secrets from Vault
        uses: hashicorp/vault-action@v3.4.0
        with:
          method: jwt
          path: ${{ vars.VAULT_AUTH_PATH }}
          url: ${{ vars.VAULT_URL }}
          role: "flyway-actions"
          secrets: |
            build-secrets/data/repos/red-gate/flyway-actions/flyway FLYWAY_PERMIT_ENTERPRISE | FLYWAY_PERMIT_ENTERPRISE;
      - name: Setup Flyway
        uses: red-gate/setup-flyway@v3
        env:
          REDGATE_LICENSING_PERMIT: ${{ env.FLYWAY_PERMIT_ENTERPRISE }}
        with:
          edition: enterprise
          i-agree-to-the-eula: true
      - name: Run migrations deploy
        id: deploy
        uses: ./migrations/deploy
        env:
          REDGATE_LICENSING_PERMIT: ${{ env.FLYWAY_PERMIT_ENTERPRISE }}
        with:
          target-url: jdbc:sqlite:database/no-drift.db
          working-directory: sample-project
      - name: Test outputs
        shell: bash
        run: |
          set -euo pipefail
          echo "Exit code: ${{ steps.deploy.outputs.exit-code }}"
          echo "Drift detected: ${{ steps.deploy.outputs.drift-detected }}"
          echo "Migrations applied: ${{ steps.deploy.outputs.migrations-applied }}"
          echo "Schema version: ${{ steps.deploy.outputs.schema-version }}"
          test "${{ steps.deploy.outputs.exit-code }}" = "0"
          test "${{ steps.deploy.outputs.drift-detected }}" = "false"
          test "${{ steps.deploy.outputs.migrations-applied }}" = "3"
          test "${{ steps.deploy.outputs.schema-version }}" = "3"

  migrations-deploy-drift:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    runs-on: ${{ matrix.os }}
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Retrieve secrets from Vault
        uses: hashicorp/vault-action@v3.4.0
        with:
          method: jwt
          path: ${{ vars.VAULT_AUTH_PATH }}
          url: ${{ vars.VAULT_URL }}
          role: "flyway-actions"
          secrets: |
            build-secrets/data/repos/red-gate/flyway-actions/flyway FLYWAY_PERMIT_ENTERPRISE | FLYWAY_PERMIT_ENTERPRISE;
      - name: Setup Flyway
        uses: red-gate/setup-flyway@v3
        env:
          REDGATE_LICENSING_PERMIT: ${{ env.FLYWAY_PERMIT_ENTERPRISE }}
        with:
          edition: enterprise
          i-agree-to-the-eula: true
      - name: Run migrations deploy
        id: deploy
        uses: ./migrations/deploy
        continue-on-error: true
        env:
          REDGATE_LICENSING_PERMIT: ${{ env.FLYWAY_PERMIT_ENTERPRISE }}
        with:
          target-url: jdbc:sqlite:database/drift.db
          working-directory: sample-project
      - name: Verify deploy failed due to drift
        shell: bash
        run: test "${{ steps.deploy.outcome }}" != "success"
      - name: Test outputs
        shell: bash
        run: |
          set -euo pipefail
          echo "Exit code: ${{ steps.deploy.outputs.exit-code }}"
          echo "Drift detected: ${{ steps.deploy.outputs.drift-detected }}"
          echo "Migrations applied: ${{ steps.deploy.outputs.migrations-applied }}"
          echo "Schema version: ${{ steps.deploy.outputs.schema-version }}"
          test "${{ steps.deploy.outputs.exit-code }}" = "1"
          test "${{ steps.deploy.outputs.drift-detected }}" = "true"
          test "${{ steps.deploy.outputs.migrations-applied }}" = ""
          test "${{ steps.deploy.outputs.schema-version }}" = ""
